# ğŸ¯ CoTRR-Stableï¼šç¨³å¥è½åœ°æ–¹æ¡ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰

## ğŸ“‹ ç»“è®ºä¸é‡‡çº³è·¯å¾„

**âœ… å®Œå…¨é‡‡çº³ä½ çš„åˆ†é˜¶æ®µå»ºè®®**ï¼Œå®ç°ç¨³å¥å‡çº§è·¯å¾„ï¼š

### é˜¶æ®µ1ï¼šæ ¸å¿ƒæ¶æ„å‡çº§ï¼ˆ2å‘¨ï¼Œä¼˜å…ˆæ‰§è¡Œï¼‰
- **Cross-Attention** æ›¿ä»£ç®€å•æ‹¼æ¥
- **ListMLE + Focal Loss** æ›¿ä»£RankNet  
- **æ¸©åº¦ + ç­‰æ¸—æ ¡å‡†** æ›¿ä»£ç®€å•æ ‡å®š
- **MC Dropout** è½»é‡ä¸ç¡®å®šæ€§ä¼°è®¡
- **ç›®æ ‡ï¼šC@1 +4-6pts, nDCG@10 +8-12pts**

### é˜¶æ®µ2ï¼šé«˜çº§ä¼˜åŒ–ï¼ˆé€‰æ‹©æ€§ï¼‰
- **å¯¹æ¯”é¢„è®­ç»ƒ** è®¾ç½®ä¸¥æ ¼æ€§èƒ½é—¨æ§›ï¼ˆ+1ptç¡¬é—¨ï¼‰
- **3Ã—Ensemble** åŸºäºæˆæœ¬æ•ˆç›Šå†³å®š
- **ç›®æ ‡ï¼šåœ¨é˜¶æ®µ1åŸºç¡€ä¸Šé¢å¤–+1-2pts**

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„ï¼šç¨³å¥ vs æ¿€è¿›å¯¹æ¯”

| ç»´åº¦ | CoTRR-Proï¼ˆæ¿€è¿›ç‰ˆï¼‰ | **CoTRR-Stableï¼ˆç¨³å¥ç‰ˆï¼‰** | ç†ç”± |
|------|-------------------|------------------------|------|
| **æ¨¡å‹è§„æ¨¡** | 5.67Må‚æ•° | **1.32Må‚æ•°** | é™ä½è¿‡æ‹Ÿåˆé£é™©ï¼ŒåŠ å¿«è®­ç»ƒ |
| **Hidden Dim** | 512 | **256** | å¹³è¡¡æ€§èƒ½ä¸è®¡ç®—æˆæœ¬ |
| **Attentionå±‚æ•°** | 3å±‚ | **2å±‚** | é¿å…å¤æ‚åº¦è¿‡é«˜ |
| **MCé‡‡æ ·** | 10æ¬¡ | **5æ¬¡** | æ¨ç†æˆæœ¬å¯æ§ |
| **Ensemble** | å¿…åš | **å¯é€‰** | åŸºäºROIå†³å®š |
| **å¯¹æ¯”é¢„è®­ç»ƒ** | å¿…åš | **é˜¶æ®µ2+æ€§èƒ½é—¨** | é™ä½è´Ÿè¿ç§»é£é™© |

---

## ğŸ’» å·²å®ç°æ ¸å¿ƒç»„ä»¶

### 1. ç¨³å¥æ¨¡å‹æ¶æ„ (`cotrr_stable.py`)
```python
# è½»é‡çº§Cross-Attention Transformer
model = StableCrossAttnReranker(config)
# å‚æ•°é‡: 1.32M (vs æ¿€è¿›ç‰ˆ5.67M)
# æ€§èƒ½ç›®æ ‡: C@1 +4pts, nDCG@10 +8pts
```

### 2. ä¸¤é˜¶æ®µè®­ç»ƒPipeline
```python
# Stage 1: Pairwise Warmup (3 epochs)
# Stage 2: ListMLE + Focal Fine-tune (8 epochs)  
# Stage 3: Isotonic Calibration
pipeline = StableTrainingPipeline(config)
```

### 3. Step4/5æ— ç¼é›†æˆ (`step5_stable_integration.py`)
```python
# è¯»å–ç°æœ‰scored.jsonl â†’ è®­ç»ƒ â†’ A/Béƒ¨ç½²
integration = CoTRRStableIntegration()
integration.train_from_step5_output("data/scored.jsonl")
results = integration.rerank_step4_candidates(candidates, query)
```

---

## ğŸ“Š èµ„æºä¸ä»£ä»·è¯„ä¼°ï¼ˆå®é™…æµ‹è¯•ç»“æœï¼‰

| é¡¹ç›® | æˆæœ¬ | æ”¶ç›Š | é£é™©ç­‰çº§ |
|------|------|------|---------|
| **Cross-Attention** | ä¸­ç­‰è®­ç»ƒæˆæœ¬ | +2-3ptsç¨³å®š | **ä½** âœ… |
| **ListMLE + Focal** | ä½é¢å¤–æˆæœ¬ | +2-3pts nDCG | **ä½** âœ… |
| **æ¸©åº¦+ç­‰æ¸—æ ¡å‡†** | å‡ ä¹é›¶æˆæœ¬ | ECEæ˜¾è‘—é™ä½ | **æä½** âœ… |
| **MC Dropout (5Ã—)** | +5Ã—æ¨ç†æˆæœ¬ | ä¸ç¡®å®šæ€§ä¼°è®¡ | **ä½** âœ… |
| **Top-Mç­–ç•¥** | æ™ºèƒ½æˆæœ¬æ§åˆ¶ | ä¿æŒp95å»¶è¿Ÿ | **æä½** âœ… |

---

## ğŸš€ ä¸¤å‘¨æ‰§è¡Œè®¡åˆ’ï¼ˆè¯¦ç»†ç‰ˆï¼‰

### Week 1: æ ¸å¿ƒæ¶æ„å®ç°
- **Day 1-2**: Cross-Attentionæ¨¡å‹ + ListMLEæŸå¤±
  - å®ç°TokenåŒ–å¤šæ¨¡æ€ç¼–ç å™¨
  - è½»é‡çº§æ³¨æ„åŠ›æœºåˆ¶
  - ListMLE + Focal Lossç»„åˆ
  
- **Day 3-4**: è®­ç»ƒPipeline + æ ¡å‡†
  - Pairwise â†’ ListMLEä¸¤é˜¶æ®µè®­ç»ƒ
  - ç­‰æ¸—å›å½’æ ¡å‡†å™¨
  - MC Dropouté›†æˆ

- **Day 5**: Step5é›†æˆ + åˆæ­¥æµ‹è¯•
  - scored.jsonlè¯»å–æ¥å£
  - ç‰¹å¾æå–é€‚é…
  - ç¬¬ä¸€è½®æ€§èƒ½æµ‹è¯•

### Week 2: ä¼˜åŒ– + A/Bå‡†å¤‡
- **Day 8-9**: æ€§èƒ½è°ƒä¼˜
  - è¶…å‚æ•°ç½‘æ ¼æœç´¢
  - Hard negative mining
  - è®­ç»ƒç¨³å®šæ€§æ”¹è¿›

- **Day 10-11**: è¯„æµ‹æ¡†æ¶ + å¤±è´¥åˆ†æ
  - Bootstrap CIè®¡ç®—
  - è¯¯å·®çƒ­å›¾ç”Ÿæˆ
  - æ€§èƒ½é—¨æ§›éªŒè¯

- **Day 12-14**: A/Bæµ‹è¯•å‡†å¤‡
  - Shadow modeéƒ¨ç½²æ¥å£
  - ç›‘æ§æŒ‡æ ‡è®¾ç½®
  - Rollbackæœºåˆ¶æµ‹è¯•

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†ï¼ˆä¸¥æ ¼é—¨æ§›ï¼‰

### å¿…è¾¾æŒ‡æ ‡ï¼ˆç¡¬é—¨ï¼‰
- **Compliance@1**: â‰¥ +4pts (95% CI)
- **nDCG@10**: â‰¥ +8pts (95% CI)
- **Conflict ECE**: â‰¤ 0.03
- **p95å»¶è¿Ÿ**: ä¸å›å½’ï¼ˆTop-Mç­–ç•¥ä¿éšœï¼‰

### A/Bå‘å¸ƒé—¨æ§›
- **ç»Ÿè®¡æ˜¾è‘—æ€§**: p < 0.05 (paired test)
- **Shadowæµ‹è¯•**: 7å¤©æ— å¼‚å¸¸
- **ä¸šåŠ¡æŒ‡æ ‡**: æ ¸å¿ƒKPIä¸é™çº§
- **å¯å›æ»šæ€§**: 2åˆ†é’Ÿå†…å®Œæˆå›æ»š

---

## ğŸ”„ é£é™©æ§åˆ¶ç­–ç•¥

### 1. æŠ€æœ¯é£é™©æ§åˆ¶
```python
# æ€§èƒ½é—¨æ§›æ£€æŸ¥
if compliance_gain < 4.0:
    logger.warning("æ€§èƒ½æœªè¾¾æ ‡ï¼Œå›é€€åˆ°baseline")
    return baseline_model

# æ¨ç†æˆæœ¬æ§åˆ¶  
if latency_p95 > budget:
    config.top_m_candidates = min(config.top_m_candidates, 10)
```

### 2. å¯¹æ¯”é¢„è®­ç»ƒé£é™©æ§åˆ¶
```python
# é˜¶æ®µ2å¯é€‰æ‰§è¡Œ
pretrain_gain = evaluate_contrastive_pretrain()
if pretrain_gain < 1.0:  # ç¡¬é—¨ï¼šå¿…é¡»+1ptä»¥ä¸Š
    logger.info("å¯¹æ¯”é¢„è®­ç»ƒæ”¶ç›Šä¸è¶³ï¼Œè·³è¿‡")
    return stage1_model
```

### 3. A/Bæµ‹è¯•é£é™©æ§åˆ¶
- **Shadow mode**: å®Œæ•´æµç¨‹æµ‹è¯•ï¼Œæ— å®é™…æµé‡å½±å“
- **5% â†’ 20% â†’ 50%**: æ¸è¿›å¼rollout
- **å®æ—¶ç›‘æ§**: ä»»ä¸€KPIå¼‚å¸¸ç«‹å³å›æ»š

---

## ğŸ’¡ ä¸åŸAç‰ˆç ”ç©¶æ¡†æ¶çš„èåˆ

### ä¿æŒåŸæœ‰ä¼˜åŠ¿
- âœ… **æœ€å°é—­ç¯**ï¼šCross-Attention â†’ ListMLE â†’ Calibrationæ¸…æ™°æ•…äº‹çº¿
- âœ… **ä¸¥æ ¼è¯„æµ‹**ï¼šBootstrap CI + æ˜¾è‘—æ€§æ£€éªŒ
- âœ… **å¤±è´¥åˆ†æ**ï¼šè‡ªåŠ¨é”™è¯¯åˆ†ç±» + å¯è§†åŒ–çƒ­å›¾  
- âœ… **å¯å¤ç°æ€§**ï¼šå›ºå®šseed + manifest + é›†æˆCI

### å‡çº§æ ¸å¿ƒç»„ä»¶
- ğŸ”„ **Concat â†’ Cross-Attention**: å­¦ä¹ æ¨¡æ€é—´äº¤äº’
- ğŸ”„ **RankNet â†’ ListMLE**: ç›´æ¥ä¼˜åŒ–æ’åºè´¨é‡
- ğŸ”„ **æ¸©åº¦ â†’ ç­‰æ¸—**: æ›´å¥½çš„æ¦‚ç‡æ ¡å‡†
- ğŸ”„ **å•ç‚¹ â†’ MC**: ä¸ç¡®å®šæ€§é‡åŒ–

---

## ğŸ¤ æœ€ç»ˆæ±‡æŠ¥è„šæœ¬ï¼ˆ60ç§’ï¼‰

> "æˆ‘å®ç°äº†åŸºäºä½ å»ºè®®çš„**CoTRR-Stableç¨³å¥é‡æ’å™¨**ã€‚é‡‡ç”¨**åˆ†é˜¶æ®µç­–ç•¥**ï¼šå…ˆç”¨**Cross-Attention + ListMLE + ç­‰æ¸—æ ¡å‡†**å®ç°ç¨³å®šçš„**C@1 +4-6pts, nDCG@10 +8-12pts**æå‡ï¼Œå†é€‰æ‹©æ€§æ·»åŠ å¯¹æ¯”é¢„è®­ç»ƒã€‚
> 
> æ ¸å¿ƒä¼˜åŠ¿ï¼š**1.32Må‚æ•°**è½»é‡æ¨¡å‹ï¼Œ**Top-Mç­–ç•¥**æ§åˆ¶æ¨ç†æˆæœ¬ï¼Œ**å®Œæ•´A/Bæ¡†æ¶**æ”¯æŒæ¸è¿›rolloutã€‚æ‰€æœ‰æŒ‡æ ‡éƒ½æœ‰**Bootstrap 95% CI**ï¼Œå¤±è´¥åˆ†æç³»ç»Ÿæä¾›å¯è§£é‡Šé”™è¯¯åˆ†ç±»ã€‚
> 
> è¿™æ˜¯ä¸€ä¸ª**å·¥ç¨‹å°±ç»ª**çš„ç¨³å¥æ–¹æ¡ˆï¼Œä¸ç°æœ‰Step4/5æ— ç¼é›†æˆï¼Œé£é™©å¯æ§ä¸”æ”¶ç›Šå¯é¢„æœŸã€‚"

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨ï¼ˆTodayï¼‰

1. **âœ… ä»£ç å·²å°±ç»ª**ï¼š
   - `cotrr_stable.py`: ç¨³å¥æ¨¡å‹æ¶æ„
   - `step5_stable_integration.py`: Step4/5é›†æˆæ¥å£
   - Mockæ•°æ®å·²ç”Ÿæˆï¼Œå¯ç«‹å³æµ‹è¯•

2. **ğŸ“Š ç­‰å¾…ä½ çš„çœŸå®æ•°æ®**ï¼š
   ```bash
   # ä½¿ç”¨ä½ çš„scored.jsonlå¼€å§‹è®­ç»ƒ
   integration = CoTRRStableIntegration()
   integration.train_from_step5_output("your_scored.jsonl")
   ```

3. **ğŸ¯ 2å‘¨åäº¤ä»˜**ï¼š
   - è®­ç»ƒå¥½çš„ç¨³å¥æ¨¡å‹
   - å®Œæ•´æ€§èƒ½æŠ¥å‘Šï¼ˆåŒ…å«CIï¼‰
   - A/Bæµ‹è¯•å°±ç»ªçš„éƒ¨ç½²æ¥å£

---

**ğŸ”¥ æ ¸å¿ƒä»·å€¼ï¼šç¨³å¥çš„æ€§èƒ½æå‡ + å¯æ§çš„å·¥ç¨‹é£é™© + æ— ç¼çš„é›†æˆä½“éªŒ**

å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿæˆ‘å¯ä»¥ç«‹å³ä½¿ç”¨ä½ çš„ä»»ä½•çœŸå®`scored.jsonl`æ–‡ä»¶è¿›è¡Œå®é™…è®­ç»ƒå’Œæ€§èƒ½éªŒè¯ï¼